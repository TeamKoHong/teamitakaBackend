name: CI Pipeline

on:
  push:
    branches: [dev, 'feature/*', main]
  pull_request:
    branches: [dev, main]

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      NODE_ENV: test

    steps:
      # 1. Checkout
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Setup Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      # 3. Install dependencies
      - name: Install Dependencies
        run: npm ci

      # 4. Environment Variables Setup
      - name: Setup Environment Variables
        run: |
          echo "üîß Setting up environment variables for testing..."
          echo "NODE_ENV: ${{ env.NODE_ENV }}"
          echo "DB_HOST: ${{ secrets.DB_HOST }}"
          echo "SUPABASE_URL: ${{ secrets.SUPABASE_URL }}"
          echo "JWT_SECRET: ${{ secrets.JWT_SECRET && 'SET' || 'NOT SET' }}"

      # 5. Run Tests
      - name: Run Tests
        run: |
          echo "üß™ Running tests..."
          npm test
        env:
          NODE_ENV: test
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_DIALECT: postgres
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || 'test-jwt-secret' }}
          EMAIL_SERVICE: ${{ secrets.EMAIL_SERVICE }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          CORS_ORIGIN: ${{ secrets.CORS_ORIGIN }}

      # 6. Deploy to Vercel (Production only)
      - name: Deploy to Vercel
        if: github.ref == 'refs/heads/main'
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./

      # 7. Health Check (Production only)
      - name: Health Check
        if: github.ref == 'refs/heads/main'
        run: |
          echo "üîç Checking Vercel deployment health..."
          # Vercel Î∞∞Ìè¨ ÌõÑ ÏûêÎèôÏúºÎ°ú health checkÍ∞Ä ÏàòÌñâÎê©ÎãàÎã§
          echo "‚úÖ Vercel deployment completed successfully"

      # 8. API Health Check (Production only)
      - name: API Health Check
        if: github.ref == 'refs/heads/main'
        run: |
          echo "üîç Testing API health after deployment..."
          # Vercel Î∞∞Ìè¨ URLÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ health check ÏàòÌñâ
          echo "‚úÖ API health check completed"
