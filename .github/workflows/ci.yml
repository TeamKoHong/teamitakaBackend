name: CI Pipeline

on:
  push:
    branches:
      - dev
      - "feature/*"
  pull_request:
    branches:
      - dev

jobs:
  build:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: teamitaka_database
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h mysql --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      # 1) 환경 변수 설정 (NODE_ENV=test)
      - name: Set environment variables
        run: echo "NODE_ENV=test" >> $GITHUB_ENV

      # 2) 소스 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v3

      # 3) Node.js 환경 설정
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: npm

      # 4) 종속성 설치
      - name: Install dependencies
        run: npm ci

      # 5) 환경 변수 디버깅 (정상 설정 확인)
      - name: Debug environment variables
        run: env | grep NODE_ENV

      # 6) MySQL 실행 대기 (더 안정적인 방식으로 변경)
      - name: Wait for MySQL
        run: |
          echo "Waiting for MySQL to be ready..."
          until nc -z mysql 3306; do
            echo "Waiting for database connection..."
            sleep 2
          done
          echo "MySQL is ready!"

      # 7) MySQL 컨테이너 상태 확인 (디버깅용)
      - name: Debug MySQL container
        run: docker logs $(docker ps -q --filter ancestor=mysql:8.0)

      # 8) MySQL 접속 테스트 (디버깅용)
      - name: Debug MySQL Connection
        run: |
          echo "Checking MySQL connection..."
          docker exec $(docker ps -q --filter ancestor=mysql:8.0) \
          mysql -uroot -proot -e "SHOW DATABASES;"

      # 9) DB 마이그레이션 실행 (테스트 환경에서는 실행하지 않음)
      - name: Run Sequelize migrations
        if: env.NODE_ENV != 'test'
        run: npx sequelize-cli db:migrate --config config/migration.config.js --env=test
    
      # 10) CSV 데이터 삽입 (마찬가지로 테스트 환경에서는 실행하지 않음)
      - name: Insert data from CSV
        if: env.NODE_ENV != 'test'
        run: node src/scripts/insertCSV.js
