name: CI Pipeline

on:
  push:
    branches:
      - dev
      - "feature/*"
  pull_request:
    branches:
      - dev

jobs:
  build-and-deploy-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Create Docker network
        run: docker network create cloudsql-net

      - name: Prepare Service Account Key
        run: |
          cat <<EOF > sa-key.json
          ${{ secrets.GCP_SA_KEY }}
          EOF

      - name: Start Cloud SQL Proxy (Docker)
        run: |
          docker run -d --name cloudsql-proxy \
            --network cloudsql-net \
            -v "$PWD/sa-key.json:/config" \
            gcr.io/cloudsql-docker/gce-proxy:1.33.7 /cloud_sql_proxy \
            -instances=${{ secrets.INSTANCE_CONNECTION_NAME }}=tcp:3306 \
            -credential_file=/config

      - name: Wait for Cloud SQL Proxy
        run: |
          echo "Waiting for Cloud SQL Proxy..."
          for i in {1..10}; do
            if docker run --rm --network cloudsql-net appropriate/nc cloudsql-proxy 3306; then
              echo "‚úÖ Cloud SQL Proxy is up!"
              break
            fi
            echo "Waiting... ($i)"
            sleep 2
          done || {
            echo "‚ùå Cloud SQL Proxy did not respond."
            exit 1
          }

      - name: Build Docker Image
        run: |
          docker build -t teamitaka-app -f Dockerfile.prod --no-cache .
        working-directory: .

      - name: Set Environment Variables
        run: |
          echo "DATABASE_URL=mysql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@cloudsql-proxy:3306/${{ secrets.DB_NAME }}" >> $GITHUB_ENV
          echo "DB_USER=${{ secrets.DB_USER }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> $GITHUB_ENV
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> $GITHUB_ENV
          echo "DB_HOST=cloudsql-proxy" >> $GITHUB_ENV
          echo "DB_PORT=3306" >> $GITHUB_ENV
          echo "NODE_ENV=production" >> $GITHUB_ENV

      - name: Ensure Database Exists
        run: |
          docker run --rm --network cloudsql-net \
            -e DB_USER=${{ env.DB_USER }} \
            -e DB_PASSWORD=${{ env.DB_PASSWORD }} \
            teamitaka-app \
            bash -c "mysql -h $DB_HOST -P $DB_PORT -u $DB_USER -p$DB_PASSWORD -e 'CREATE DATABASE IF NOT EXISTS \`${{ env.DB_NAME }}\` CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;'"

      - name: Reset Migrations using reset-migrations.sh
        run: |
          docker run --rm --network cloudsql-net \
            -v ${{ github.workspace }}/reset-migrations.sh:/app/reset-migrations.sh \
            -e DATABASE_URL=${{ env.DATABASE_URL }} \
            teamitaka-app \
            bash /app/reset-migrations.sh

      - name: Insert Mockup Data
        run: |
          docker run --rm --network cloudsql-net \
            -v ${{ github.workspace }}/src/data:/app/data \
            -e DATABASE_URL=${{ env.DATABASE_URL }} \
            teamitaka-app \
            node src/scripts/loadMockupData.js --users --recruitments --projects --verbose

      - name: Insert CSV Data
        run: |
          docker run --rm --network cloudsql-net \
            -v ${{ github.workspace }}/seeders:/app/seeders \
            -e DATABASE_URL=${{ env.DATABASE_URL }} \
            teamitaka-app \
            node src/scripts/insertCSV.js

      - name: Deploy and Test Application
        run: |
          docker run -d --network cloudsql-net \
            --name teamitaka-prod \
            -e DATABASE_URL="${{ env.DATABASE_URL }}" \
            -e NODE_ENV=production \
            -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            teamitaka-app npm run start

          echo "‚è≥ Waiting for server..."
          sleep 20

          echo "üîç Health check..."
          docker exec teamitaka-prod curl -s http://localhost:3000/health || {
            docker logs teamitaka-prod
            exit 1
          }

      - name: Cleanup
        run: |
          docker stop cloudsql-proxy || true
          docker rm cloudsql-proxy || true
          docker network rm cloudsql-net || true