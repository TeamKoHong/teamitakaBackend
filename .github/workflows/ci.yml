name: CI Pipeline

on:
  push:
    branches: [dev, 'feature/*']
  pull_request:
    branches: [dev]

jobs:
  build-and-deploy-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    env:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      IMAGE_NAME: teamitaka-backend

    steps:
      # 1. Checkout
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2. Setup Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # 3. Install dependencies
      - name: Install Dependencies
        run: npm ci

      # 4.1. Ensure Database Exists (Cloud SQL)
      - name: Ensure Database Exists
        run: |
          echo "ğŸ” Ensuring database exists on Cloud SQL..."
          mysql -h ${{ secrets.DB_HOST }} -u ${{ secrets.DB_USER }} -p${{ secrets.DB_PASSWORD }} -e "CREATE DATABASE IF NOT EXISTS \`${{ secrets.DB_NAME }}\` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;"
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}

      # 4. Database Setup (Development/Test Environment)
      - name: Setup Database for Testing
        run: |
          echo "ğŸ”§ Setting up database for testing environment..."
          echo "DB_HOST: ${{ secrets.DB_HOST }}"
          echo "DB_USER: ${{ secrets.DB_USER }}"
          echo "DB_NAME: ${{ secrets.DB_NAME }}"
          echo "DB_PORT: ${{ secrets.DB_PORT }}"
          
          # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          export NODE_ENV=development
          export DB_HOST=${{ secrets.DB_HOST }}
          export DB_USER=${{ secrets.DB_USER }}
          export DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          export DB_NAME=${{ secrets.DB_NAME }}
          export DB_PORT=${{ secrets.DB_PORT }}
          export JWT_SECRET=${{ secrets.JWT_SECRET || 'default-jwt-secret-for-testing' }}
          
          # DB ì´ˆê¸°í™” ì‹¤í–‰
          npm run db:init:simple:dev
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_PORT: ${{ secrets.DB_PORT }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || 'default-jwt-secret-for-testing' }}

      # 5. API Tests (Optional - if you have tests)
      - name: Run API Tests
        run: |
          echo "ğŸ§ª Running API tests..."
          # ì—¬ê¸°ì— API í…ŒìŠ¤íŠ¸ ì¶”ê°€ ê°€ëŠ¥
          echo "âœ… API tests completed (placeholder)"
        continue-on-error: true

      # 6. Authenticate with gcloud
      - name: Authenticate with gcloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 7. Set up gcloud CLI
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # 8. Configure Docker for Artifact Registry
      - name: Configure Docker
        run: gcloud auth configure-docker us-central1-docker.pkg.dev

      # 9. Build Docker image
      - name: Build Docker Image
        run: |
          docker build -t us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}/${{ env.IMAGE_NAME }} -f Dockerfile.prod .

      # 10. Push to Artifact Registry
      - name: Push Docker Image
        run: |
          docker push us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}/${{ env.IMAGE_NAME }}

      # 11. Deploy to Cloud Run
      - name: Deploy to Cloud Run
        id: deploy
        run: |
          echo "ğŸ” Checking environment variables..."
          echo "DB_HOST: ${{ secrets.DB_HOST }}"
          echo "DB_USER: ${{ secrets.DB_USER }}"
          echo "DB_NAME: ${{ secrets.DB_NAME }}"
          echo "DB_PORT: ${{ secrets.DB_PORT }}"
          echo "JWT_SECRET: ${{ secrets.JWT_SECRET && 'SET' || 'NOT SET' }}"
          
          # JWT_SECRETì´ ìˆìœ¼ë©´ í¬í•¨, ì—†ìœ¼ë©´ ì œì™¸
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
            ENV_VARS="NODE_ENV=production,JWT_SECRET=${{ secrets.JWT_SECRET }},DB_HOST=${{ secrets.DB_HOST }},DB_USER=${{ secrets.DB_USER }},DB_PASSWORD=${{ secrets.DB_PASSWORD }},DB_NAME=${{ secrets.DB_NAME }},DB_PORT=${{ secrets.DB_PORT }}"
            echo "âœ… JWT_SECRET included in environment variables"
          else
            ENV_VARS="NODE_ENV=production,DB_HOST=${{ secrets.DB_HOST }},DB_USER=${{ secrets.DB_USER }},DB_PASSWORD=${{ secrets.DB_PASSWORD }},DB_NAME=${{ secrets.DB_NAME }},DB_PORT=${{ secrets.DB_PORT }}"
            echo "âš ï¸  JWT_SECRET not set, using default value"
          fi
          
          gcloud run deploy ${{ env.IMAGE_NAME }} \
            --image us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}/${{ env.IMAGE_NAME }} \
            --platform managed \
            --region us-central1 \
            --allow-unauthenticated \
            --add-cloudsql-instances ${{ secrets.INSTANCE_CONNECTION_NAME }} \
            --set-env-vars "$ENV_VARS" \
            --format "value(status.url)" > service_url.txt
          
          echo "service_url=$(cat service_url.txt)" >> $GITHUB_OUTPUT
          echo "ğŸ” Service URL: $(cat service_url.txt)"

      # 11.1. Ensure Database Exists (Cloud SQL)
      - name: Ensure Database Exists
        run: |
          echo "ğŸ” Ensuring database exists on Cloud SQL..."
          mysql -h ${{ secrets.DB_HOST }} -u ${{ secrets.DB_USER }} -p${{ secrets.DB_PASSWORD }} -e "CREATE DATABASE IF NOT EXISTS \`${{ secrets.DB_NAME }}\` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;"

      # 11.5. Initialize DB Tables and Insert Sample Data (Production)
      - name: Initialize DB Tables and Insert Sample Data (Production)
        run: |
          echo "ğŸ”§ Initializing DB tables and inserting sample data in production..."
          docker run --rm \
            -e NODE_ENV=production \
            -e DB_HOST=${{ secrets.DB_HOST }} \
            -e DB_USER=${{ secrets.DB_USER }} \
            -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
            -e DB_NAME=${{ secrets.DB_NAME }} \
            -e DB_PORT=${{ secrets.DB_PORT }} \
            -e JWT_SECRET=${{ secrets.JWT_SECRET }} \
            us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}/${{ env.IMAGE_NAME }} \
            node scripts/init-db.js

      # 12. Wait for service to be ready + Health Check
      - name: Wait and Check Health
        run: |
          echo "ğŸ” Cloud Run service URL: ${{ steps.deploy.outputs.service_url }}"
          echo "â³ Waiting for service to be ready..."
          sleep 60
          echo "ğŸ¥ Attempting health check..."
          curl -f "${{ steps.deploy.outputs.service_url }}/health" || {
            echo "âŒ Health check failed - Database connection is required for deployment success"
            echo "ğŸ“‹ Service URL: ${{ steps.deploy.outputs.service_url }}"
            echo "ğŸ“‹ Recent logs:"
            gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=${{ env.IMAGE_NAME }}" --limit=20 --format="value(timestamp,textPayload)"
            echo "âŒ Deployment failed: Application cannot connect to database"
            echo "ğŸ’¡ Please check GitHub Secrets for database environment variables:"
            echo "   - DB_HOST"
            echo "   - DB_USER" 
            echo "   - DB_PASSWORD"
            echo "   - DB_NAME"
            echo "   - DB_PORT (optional)"
            exit 1
          }
          echo "âœ… Health check passed! Database connection successful."

      # 13. API Test with Seed Data
      - name: Test API with Seed Data
        run: |
          echo "ğŸ§ª Testing API endpoints with seed data..."
          SERVICE_URL="${{ steps.deploy.outputs.service_url }}"
          
          # í…ŒìŠ¤íŠ¸ ì‚¬ìš©ìë¡œ ë¡œê·¸ì¸í•˜ì—¬ í† í° íšë“
          echo "ğŸ” Testing login with seed user..."
          LOGIN_RESPONSE=$(curl -s -X POST "$SERVICE_URL/api/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"test@example.com","password":"password"}')
          
          echo "Login response: $LOGIN_RESPONSE"
          
          # í† í° ì¶”ì¶œ (ê°„ë‹¨í•œ ë°©ë²•)
          TOKEN=$(echo $LOGIN_RESPONSE | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
          
          if [ -n "$TOKEN" ]; then
            echo "âœ… Login successful, testing protected endpoints..."
            
            # ëª¨ì§‘ê³µê³  ì¡°íšŒ í…ŒìŠ¤íŠ¸
            echo "ğŸ“‹ Testing recruitment list..."
            curl -s -H "Authorization: Bearer $TOKEN" "$SERVICE_URL/api/recruitments" | head -c 200
            
            # í”„ë¡œì íŠ¸ ì¡°íšŒ í…ŒìŠ¤íŠ¸
            echo "ğŸ“‹ Testing project list..."
            curl -s -H "Authorization: Bearer $TOKEN" "$SERVICE_URL/api/projects" | head -c 200
            
            echo "âœ… API tests completed successfully!"
          else
            echo "âš ï¸  Login failed, but deployment is still successful"
            echo "ğŸ’¡ This might be due to seed data not being available in production"
          fi
        continue-on-error: true
